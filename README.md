# Ecru App — Architecture Overview

This document explains the structure, data flows, and key technologies used in this app so new contributors can get productive quickly.

## Stack
- React 19 + TypeScript
- Vite 6 for build/dev
- TanStack Router (file-based) for routing
- TanStack Query for server state and mutations
- PocketBase as the backend (hosted at `https://ecru-pb.onrender.com`)
- TipTap for rich text editing with custom suggestions/mentions
- dnd-kit for drag-and-drop sorting

## Project layout
```
├─ public/                 # Static assets
├─ src/
│  ├─ components/
│  │  ├─ ProtectedRoute.tsx
│  │  ├─ RichTextEditor.tsx
│  │  ├─ RichTextEditor.module.css
│  │  ├─ SuggestionList.tsx
│  │  └─ MentionList.tsx
│  ├─ hooks/
│  │  ├─ useAuth.ts        # OTP auth via PocketBase
│  │  ├─ useTasks.ts       # Tasks queries/mutations + optimistic updates
│  │  └─ useSuggestions.ts # TipTap suggestion controller
│  ├─ routes/              # File-based routes (TanStack Router)
│  │  ├─ __root.tsx        # Root route; provides app context
│  │  ├─ _layout.tsx       # Authenticated app shell (logout, outlet)
│  │  ├─ _layout.index.tsx # Tasks page (drag/reorder, create, delete)
│  │  ├─ login.tsx
│  │  └─ signup.tsx
│  ├─ types/
│  │  ├─ app.ts            # Router context types
│  │  └─ pocketbase.ts     # Generated via pocketbase-typegen
│  ├─ utils/
│  │  └─ extractHeadingFromHtml.ts
│  ├─ main.tsx             # Router, QueryClient & PocketBase wiring
│  ├─ routeTree.gen.ts     # Generated by router plugin
│  ├─ normalize.css        # Modern normalize
│  └─ styles.css           # App styles (auth, tasks, loader, etc.)
├─ vite.config.ts
├─ tsconfig.json           # Path alias `@/*` → `src/*`
└─ README.md               # This document
```

## Runtime architecture

### Entry and providers
- `src/main.tsx` wires up:
  - PocketBase client: `new PocketBase('https://ecru-pb.onrender.com')`
  - TanStack Query: `QueryClient` + `QueryClientProvider`
  - TanStack Router: `createRouter({ routeTree, context: { queryClient, pb } })`
- Router context is strongly typed via `AppContext` (`src/types/app.ts`) and exposed to routes/hooks through `useRouteContext`.

### Routing
- File-based routing with `@tanstack/router-plugin` generates `src/routeTree.gen.ts` from files in `src/routes`.
- `src/routes/__root.tsx` is the root. It renders `<Outlet />` and Router Devtools and defines the context type.
- `src/routes/_layout.tsx` is a child layout that displays a Logout button and the nested outlet. The tasks UI is nested under this layout.
- Auth pages live at `src/routes/login.tsx` and `src/routes/signup.tsx`.

#### Route protection
- `components/ProtectedRoute.tsx` uses `useAuth()` to gate children. While loading, it shows a loading state; if unauthenticated, it redirects to `/login` using TanStack Router's `<Navigate />`.
- The tasks index route (`_layout.index.tsx`) wraps the page with `<ProtectedRoute>`.

### Authentication (PocketBase, OTP)
- `hooks/useAuth.ts` integrates with `pb.authStore` and exposes:
  - `requestOTP(email)` → `users.requestOTP`
  - `verifyOTP(otpId, otpCode)` → `users.authWithOTP` (sets `authStore` and local `user`)
  - `signup(email, name?)` → creates a user with a random password (OTP verification still required)
  - `logout()` → clears `authStore`
- `useAuth` subscribes to `pb.authStore.onChange` so UI stays in sync with auth state.

### Tasks domain
- `hooks/useTasks.ts` manages server state for `tasks` using TanStack Query:
  - Query: fetches the authenticated user's tasks via `pb.collection('tasks').getFullList`, sorted by `position,-created`.
  - Create: batch-shifts existing pending task positions down by 1 and inserts a new task at position 1. Supports deriving a title from the rich description's first heading via `extractHeadingFromHtml`.
  - Toggle complete: sets/clears ISO datetime in `completed`.
  - Reorder: batch-updates `position` for drag/drop reorder.
  - Delete: removes a task by `id`.
  - Each mutation uses optimistic updates with safe rollback on error and invalidates the `['tasks']` query on settle.
- `routes/_layout.index.tsx` is the UI for tasks:
  - Create form: plain title input plus TipTap rich text editor; title auto-fills from first heading if omitted.
  - Pending tasks list with drag-and-drop using `@dnd-kit/*` (keyboard and pointer sensors).
  - Toggle complete, delete; visual styling from `styles.css` and `RichTextEditor.module.css`.

#### PocketBase collections
The code expects a `tasks` collection with, at minimum:
- `title` (string)
- `description` (string, optional)
- `rich_description` (string, optional)
- `position` (number)
- `completed` (string/ISO datetime or empty string)
- `user` (relation to `users`)
Plus standard PocketBase fields: `id`, `created`, `updated`, etc.

Types for `TasksResponse` and `UsersResponse` come from `src/types/pocketbase.ts` (generated).

### Rich text editor
- `components/RichTextEditor.tsx` builds a TipTap editor with:
  - StarterKit, Placeholder, Mention extensions
  - A floating formatting toolbar (bold, italic, strike, headings, lists, quote)
  - Suggestion system driven by `hooks/useSuggestions.ts` and rendered via `components/SuggestionList.tsx`
  - Default demo suggestion configs for `@` (people) and `/` (tags), overridable via props
- Styling lives in `RichTextEditor.module.css`.

### Styling
- `normalize.css` provides a modern baseline.
- `styles.css` contains form, auth, task list, and global utility styles, including a `.full-page-loader` used as the router's `defaultPendingComponent`.
- Editor-specific styles are in the CSS module.

## Tooling
- `vite.config.ts` merges a base Vite config with `@tanstack/vite-config` (sets entry `src/main.tsx`, `srcDir: ./src`).
- `tsconfig.json` uses bundler module resolution and defines a path alias `@/*` → `src/*`.
- `pocketbase-typegen` generates `src/types/pocketbase.ts` from the running PocketBase instance.

## Development
- Install deps: `npm install`
- Start dev server: `npm run dev` (port 3000)
- Preview prod build: `npm run serve` (port 10000)
- Build: `npm run build` (Vite build + `tsc --noEmit` typecheck)
- Tests: `npm run test` (Vitest)
- Generate PocketBase types: `npm run pb:generate`

### Configuring the backend endpoint
- The PocketBase base URL is set in `src/main.tsx`:
  ```ts
  const pb = new PocketBase('https://ecru-pb.onrender.com')
  ```
  Change this to your environment as needed.

## Adding features
- Routes: create a file in `src/routes` (the plugin regenerates `routeTree.gen.ts`). Use `createFileRoute` and `createRootRouteWithContext` patterns seen in existing files.
- Auth-only pages: wrap your component with `ProtectedRoute` or guard inside the route component using `useAuth()`.
- Data fetching: prefer TanStack Query. Access `pb` from the router context with `useRouteContext({ from: '__root__' })` and invalidate queries after mutations.
- Drag-and-drop: use `@dnd-kit`'s `DndContext` and `SortableContext`. See `_layout.index.tsx` for list and item patterns.
- Editor: reuse `RichTextEditor` and `useSuggestions` to add commands/mentions.

## Generated files
- `src/routeTree.gen.ts` is generated by the router plugin — do not edit.
- `src/types/pocketbase.ts` is generated by `pocketbase-typegen` — do not edit.

## Conventions
- TypeScript strict mode is enabled. Favor explicit, narrow types.
- Use the `@/*` path alias for imports from `src`.
- Keep mutations optimistic where practical and always handle error rollbacks.

## Troubleshooting
- If routes fail to resolve, ensure the router plugin is running (via Vite) so `routeTree.gen.ts` is regenerated.
- If PocketBase types are stale, run `npm run pb:generate` against the correct backend.
- Auth issues: verify the backend URL and that OTP emails/codes are working in the target environment.

---
Happy hacking! If anything here gets out of date, please update this README as part of your change.
